{% extends "base.html" %}

{% block page_title %}库存仪表盘{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        padding: 20px;
        border-radius: 12px;
        color: white;
        transition: transform 0.3s;
        min-height: 140px;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
    }

    .stat-card .stat-icon {
        font-size: 2.5rem;
        opacity: 0.7;
    }

    .stat-card .stat-value {
        font-size: 1.8rem;
        font-weight: 700;
    }

    .stat-card .stat-label {
        opacity: 0.9;
        font-size: 0.95rem;
    }

    .card-header {
        font-weight: 700;
    }

    .list-group-item {
        border-radius: 8px !important;
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <!-- 统计卡片 -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stat-card" style="background: linear-gradient(120deg, #3498db, #2c3e50);">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stat-label">总库存价值</div>
                    <div class="stat-value">¥{{ total_value|floatformat:2 }}</div>
                </div>
                <div class="stat-icon">
                    <i class="fas fa-dollar-sign"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stat-card" style="background: linear-gradient(120deg, #2ecc71, #27ae60);">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stat-label">总库存量</div>
                    <div class="stat-value">{{ total_stock }}</div>
                </div>
                <div class="stat-icon">
                    <i class="fas fa-boxes"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
    <div class="card stat-card bg-danger h-100">
        <div class="card-body">
            <div class="d-flex justify-content-between">
                <div>
                    <h5 class="card-title text-white-50">库存预警</h5>
                    <div class="stat-value">{{ alert_count }}</div>
                </div>
                <div>
                    <i class="fas fa-exclamation-triangle fa-2x text-white-50"></i>
                </div>
            </div>
        </div>
    </div>
</div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stat-card" style="background: linear-gradient(120deg, #f39c12, #d35400);">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stat-label">待审批订单</div>
                    <div class="stat-value">{{ pending_purchases|add:pending_sales }}</div>
                </div>
                <div class="stat-icon">
                    <i class="fas fa-file-signature"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- 库存趋势图 -->
    <div class="col-xl-8 mb-4">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0">库存趋势分析</h5>
            </div>
            <div class="card-body">
                <canvas id="inventoryTrendChart" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- 库存分布饼图 -->
    <div class="col-xl-4 mb-4">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0">库存类别分布</h5>
            </div>
            <div class="card-body">
                <canvas id="inventoryDistributionChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- 库存预警区域 -->
    <div class="col-lg-5 mb-4">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0 d-flex align-items-center">
                    <i class="fas fa-exclamation-circle me-2 text-danger"></i>低库存产品
                    <span class="badge bg-danger ms-2">{{ low_stock_products|length }}</span>
                </h5>
            </div>
            <div class="card-body">
                {% if low_stock_products %}
                <div class="list-group">
                    {% for product in low_stock_products %}
<a href="{% url 'inventory:product_detail' pk=product.id %}"
   class="list-group-item list-group-item-action {% if product.current_stock == 0 %}list-group-item-danger{% else %}list-group-item-warning{% endif %}">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h6 class="mb-1">{{ product.name }}</h6>
            <small class="text-muted">{{ product.code }}</small>
        </div>
        <div>
            <span class="badge {% if product.current_stock == 0 %}bg-danger{% else %}bg-warning{% endif %}">
                {{ product.current_stock }} / {{ product.alert_threshold }}
            </span>
        </div>
    </div>
</a>
{% endfor %}
                </div>
                <div class="mt-3 text-center">
                    <a href="{% url 'inventory:low_stock_report' %}" class="btn btn-outline-danger">
                        <i class="fas fa-file-alt me-1"></i>查看完整报告
                    </a>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                    <p class="lead">暂无库存预警产品</p>
                    <small class="text-muted">所有产品库存充足</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 最近库存变动 -->
    <div class="col-lg-7 mb-4">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history me-2 text-primary"></i>最近库存变动
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>时间</th>
                                <th>类型</th>
                                <th>产品</th>
                                <th>数量</th>
                                <th>操作员</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in recent_logs %}
                            <tr>
                                <td>{{ log.created_at|date:"Y-m-d H:i" }}</td>
                                <td>
                                    <span class="badge {% if log.transaction_type == 'IN' %}bg-success{% elif log.transaction_type == 'OUT' %}bg-danger{% else %}bg-info{% endif %}">
                                        {{ log.get_transaction_type_display }}
                                    </span>
                                </td>
                                <td>{{ log.product.name }}</td>
                                <td class="{% if log.quantity > 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                                    {{ log.quantity|floatformat:0 }}
                                </td>
                                <td>{{ log.operator }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-4">最近无库存变动记录</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="mt-3 text-center">
                    <a href="{% url 'inventory:transaction_report' %}" class="btn btn-outline-primary">
                        <i class="fas fa-file-alt me-1"></i>查看交易报告
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

{% if pending_purchases > 0 or pending_sales > 0 %}
<div class="row">
    <!-- 待审批采购订单 -->
    {% if pending_purchases > 0 and perms.inventory.approve_purchase %}
    <div class="col-md-6 mb-4">
        <div class="card border-warning">
            <div class="card-header bg-warning text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-clipboard-list me-2"></i>待审批采购订单
                    <span class="badge bg-danger ms-2">{{ pending_purchases }}</span>
                </h5>
            </div>
            <div class="card-body">
                <p class="card-text">有{{ pending_purchases }}个采购订单等待审批</p>
                <a href="{% url 'inventory:purchase_approval' %}" class="btn btn-warning">
                    <i class="fas fa-clipboard-check me-1"></i>前往审批
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 待审批销售订单 -->
    {% if pending_sales > 0 and perms.inventory.approve_sales %}
    <div class="col-md-6 mb-4">
        <div class="card border-warning">
            <div class="card-header bg-warning text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-file-invoice-dollar me-2"></i>待审批销售订单
                    <span class="badge bg-danger ms-2">{{ pending_sales }}</span>
                </h5>
            </div>
            <div class="card-body">
                <p class="card-text">有{{ pending_sales }}个销售订单等待审批</p>
                <a href="{% url 'inventory:sales_approval' %}" class="btn btn-warning">
                    <i class="fas fa-file-signature me-1"></i>前往审批
                </a>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
// 初始化库存趋势图
const trendCtx = document.getElementById('inventoryTrendChart').getContext('2d');
const trendChart = new Chart(trendCtx, {
    type: 'line',
    data: {
        labels: [{% for item in inventory_trend %}"{{ item.date }}"{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [{
            label: '库存价值 (千元)',
            data: [{% for item in inventory_trend %}{{ item.value|floatformat:0 }}{% if not forloop.last %},{% endif %}{% endfor %}],
            borderColor: '#3498db',
            backgroundColor: 'rgba(52, 152, 219, 0.1)',
            borderWidth: 3,
            tension: 0.3,
            fill: true,
            pointRadius: 4,
            pointBackgroundColor: '#3498db'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                mode: 'index',
                intersect: false
            }
        },
        scales: {
            y: {
                beginAtZero: false,
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                },
                ticks: {
                    callback: function(value) {
                        return '¥' + value + 'k';
                    }
                }
            },
            x: {
                grid: {
                    display: false
                }
            }
        }
    }
});

// 初始化库存分布饼图
const distCtx = document.getElementById('inventoryDistributionChart').getContext('2d');
const distChart = new Chart(distCtx, {
    type: 'doughnut',
    data: {
        labels: [{% for item in category_distribution %}'{{ item.category }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [{
            data: [{% for item in category_distribution %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
            backgroundColor: [
                '#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6',
                '#1abc9c', '#d35400', '#c0392b', '#16a085', '#8e44ad'
            ],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'right'
            }
        },
        cutout: '60%'
    }
});

// 每5分钟刷新一次仪表盘数据
setTimeout(function() {
    location.reload();
}, 300000);
</script>
{% endblock %}