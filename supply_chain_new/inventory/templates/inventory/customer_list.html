{% extends "base.html" %}
{% load static %}

{% block page_title %}客户管理{% endblock %}

{% block header_actions %}
<div>
    <a href="{% url 'admin:inventory_customer_add' %}" class="btn btn-success me-1">
        <i class="fas fa-plus me-1"></i>添加客户
    </a>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#importModal">
        <i class="fas fa-file-import me-1"></i>批量导入
    </button>
</div>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">客户列表</h5>
            <div>
                <form method="get" class="d-inline">
                    <div class="input-group">
                        <input type="text" class="form-control" name="q" placeholder="搜索客户..." value="{{ request.GET.q }}">
                        <button class="btn btn-outline-primary" type="submit">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="card-body">
        {% if object_list %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>客户名称</th>
                        <th>联系人</th>
                        <th>电话</th>
                        <th>邮箱</th>
                        <th>地址</th>
                        <th>客户等级</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for customer in object_list %}
                    <tr>
                        <td>
                            <a href="{% url 'inventory:customer_detail' pk=customer.id %}" class="fw-bold">
                                {{ customer.name }}
                            </a>
                        </td>
                        <td>{{ customer.contact_person }}</td>
                        <td>{{ customer.phone }}</td>
                        <td>{{ customer.email }}</td>
                        <td>{{ customer.address|truncatechars:20 }}</td>
                        <td>
                            <span class="badge
                                {% if customer.level == 'VIP' %}bg-danger
                                {% elif customer.level == '一级' %}bg-warning
                                {% elif customer.level == '二级' %}bg-primary
                                {% else %}bg-secondary{% endif %}">
                                {{ customer.level }}
                            </span>
                        </td>
                        <td>
                            <a href="{% url 'admin:inventory_customer_change' customer.id %}"
                               class="btn btn-sm btn-outline-secondary me-1" title="编辑">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="{% url 'inventory:customer_detail' pk=customer.id %}"
                               class="btn btn-sm btn-outline-primary" title="详情">
                                <i class="fas fa-info-circle"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- 分页导航 -->
        {% if is_paginated %}
        <nav class="mt-4">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1&q={{ request.GET.q }}">
                        &laquo; 第一页
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ request.GET.q }}">
                        上一页
                    </a>
                </li>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                    <li class="page-item active">
                        <a class="page-link" href="#">{{ num }}</a>
                    </li>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ num }}&q={{ request.GET.q }}">
                            {{ num }}
                        </a>
                    </li>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ request.GET.q }}">
                        下一页
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&q={{ request.GET.q }}">
                        最后页 &raquo;
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}

        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-users fa-3x text-muted mb-3"></i>
            <p class="lead">没有找到客户</p>
            <p class="text-muted mb-4">开始添加您的第一个客户</p>
            <a href="{% url 'admin:inventory_customer_add' %}" class="btn btn-success">
                <i class="fas fa-plus me-1"></i>添加客户
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- 批量导入模态框 -->
<div class="modal fade" id="极importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importModalLabel">批量导入客户</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="importFile" class="form-label">选择Excel文件</label>
                    <input class="form-control" type="file" id="importFile" accept=".xlsx,.xls">
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-1"></i> 请使用标准格式的Excel模板
                    <a href="{% static 'templates/customer_import_template.xlsx' %}" class="d-block mt-2">
                        <i class="fas fa-download me-1"></i> 下载导入模板
                    </a>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="startImport">
                    <i class="fas fa-file-import me-1"></i> 开始导入
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('startImport').addEventListener('click', function() {
    const fileInput = document.getElementById('importFile');
    if (!fileInput.files || !fileInput.files[0]) {
        alert('请选择要导入的Excel文件');
        return;
    }

    // 显示加载指示器
    showLoading();

    // TODO: 添加实际的导入逻辑
    setTimeout(function() {
        hideLoading();
        alert('客户导入成功！');
        location.reload();
    }, 2000);
});
</script>
{% endblock %}